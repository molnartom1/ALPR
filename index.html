<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8"/>
  <title>Rendsz√°mfigyel√©s ‚Äì Kapu vez√©rl≈ë</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; background: #0b1220; color: #e2e8f0; }
    h1 { margin: 0 0 8px }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 16px; padding: 16px; box-shadow: 0 10px 20px rgba(0,0,0,.2); }
    .snapshot { width: 100%; height: auto; border-radius: 12px; border: 1px solid #1f2937; background:#0f172a; }
    .btn { display:inline-block; padding:10px 14px; border-radius: 10px; border:1px solid #334155; background:#1f2937; color:#e2e8f0; text-decoration:none; cursor:pointer }
    .btn:hover { background:#374151 }
    table { width:100%; border-collapse: collapse; margin-top: 8px; }
    th, td { text-align:left; padding: 8px; border-bottom: 1px solid #1f2937; }
    .muted { color:#94a3b8; font-size: 0.9em; }
    .flex { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    input[type=text], input[type=number] { background:#0f172a; border:1px solid #334155; border-radius:10px; color:#e2e8f0; padding:8px 10px; }
    form.inline > * { margin-right:8px; }
    .toast { position: fixed; right:16px; bottom:16px; background:#065f46; color:#ecfdf5; border:1px solid #10b981; border-radius:12px; padding:12px 16px; box-shadow:0 10px 20px rgba(0,0,0,.25); font-weight:600; display:none; }
    .toast.show { display:block; }
  </style>
</head>
<body>
  <h1>Rendsz√°mfigyel√©s ‚Äì Kapu vez√©rl≈ë</h1>
  <div class="muted">Localhost dashboard ‚Ä¢ Friss√ºl automatikusan</div>

  <div class="grid" style="margin-top:16px">
    <div class="card">
      <div class="flex" style="justify-content:space-between; gap:10px;">
        <h2 style="margin:0">Kamerak√©p</h2>
        <div class="flex">
          <form class="inline" onsubmit="return addPlate(event)">
            <input id="inpPlate" type="text" placeholder="Rendsz√°m (pl. AA-AA-123)" required />
            <input id="inpOwner" type="text" placeholder="Tulaj / megjegyz√©s (opcion√°lis)" />
            <button class="btn" type="submit">‚ûï Hozz√°ad√°s</button>
          </form>
          <button class="btn" onclick="reloadWhitelist()">üîÑ Whitelist friss√≠t√©s</button>
          <button class="btn" onclick="openGate()">üîì K√©zi nyit√°s</button>
        </div>
      </div>
      <img id="snapshot" class="snapshot" src="/snapshot.jpg?ts={{ts}}" alt="snapshot"/>
      <div id="status" class="muted" style="margin-top:8px"></div>
      <div id="flash" class="muted" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h2 style="margin:0">Legut√≥bbi esem√©nyek</h2>
      <table id="events">
        <thead>
          <tr><th>Id≈ë</th><th>Rendsz√°m</th><th>Conf%</th><th>Tulaj</th><th>Akci√≥</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2 style="margin:0">Teszt felismer√©s (szimul√°ci√≥)</h2>
      <p class="muted">Adj meg egy rendsz√°mot √©s (opcion√°lisan) egy felismer√©si pontsz√°mot. A rendszer ugyanazt a logik√°t futtatja, mintha a kamera olvasta volna ki.</p>
      <form class="inline" onsubmit="return simulate(event)">
        <input id="simPlate" type="text" placeholder="Rendsz√°m (pl. AA-AA-123)" required />
        <input id="simConf" type="number" min="0" max="100" step="0.1" placeholder="Confidence % (pl. 95)" />
        <button class="btn" type="submit">‚ñ∂Ô∏è Szimul√°l</button>
      </form>
      <div class="muted" style="margin-top:8px">Megjegyz√©s: ha a CONF kisebb, mint a k√ºsz√∂b ({{min_conf}}%), akkor <i>low_conf</i> esem√©ny lesz.</div>
    </div>
  </div>

  <div id="toast" class="toast">NYITVA!</div>

<script>
let SNAPSHOT_MS = 1500;
let EVENTS_MS = 2000;
let STATUS_MS = 1500;

function refreshSnapshot(){ document.getElementById('snapshot').src = '/snapshot.jpg?ts=' + Date.now(); }
function refreshEvents(){
  fetch('/events').then(r => r.json()).then(data => {
    const tb = document.querySelector('#events tbody'); tb.innerHTML = '';
    const list = (data.events || []);
    let justOpened = false;
    list.forEach((ev, idx) => {
      const tr = document.createElement('tr');
      const conf = (ev.confidence===null || ev.confidence===undefined) ? '' : Number(ev.confidence).toFixed(1);
      tr.innerHTML = `
        <td class="mono">${(ev.timestamp||'').replace('T',' ')}</td>
        <td class="mono">${ev.plate||''}</td>
        <td>${conf}</td>
        <td>${ev.owner||''}</td>
        <td>${ev.action||''}</td>`;
      tb.appendChild(tr);
      if (idx === 0 && (ev.action === 'open' || ev.action === 'open(manual)')) justOpened = true;
    });
    if (justOpened) { const t=document.getElementById('toast'); t.textContent='NYITVA!'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); }
  });
}
function refreshStatus(){
  fetch('/status').then(r => r.json()).then(s => {
    const el = document.getElementById('status');
    const p = s.last_plate ? `<span class="mono">${s.last_plate}</span> (${(s.last_conf||0).toFixed(1)}%)` : 'nincs tal√°lat';
    el.innerHTML = `Utols√≥ tal√°lat: ${p} ‚Ä¢ K√©p friss√≠tve: ${s.last_frame_age_ms} ms`;
  });
}

function openGate(){
  fetch('/open_gate', {method:'POST'}).then(r=>r.json()).then(j=>flash(j.message||'OK'));
}
function reloadWhitelist(){
  fetch('/reload_whitelist', {method:'POST'}).then(r=>r.json()).then(j=>flash(j.message||'Whitelist friss√≠tve'));
}
function addPlate(ev){
  ev.preventDefault();
  const plate = document.getElementById('inpPlate').value.trim();
  const owner = document.getElementById('inpOwner').value.trim();
  fetch('/add_plate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({plate,owner})})
  .then(r=>r.json().then(j=>({ok:r.ok,status:r.status,body:j})))
  .then(res=>{
    flash(res.body.message || (res.ok?'Hozz√°adva':'Hiba'));
    if(res.ok){ document.getElementById('inpPlate').value=''; document.getElementById('inpOwner').value=''; reloadWhitelist(); }
  });
  return false;
}
function simulate(ev){
  ev.preventDefault();
  const plate = document.getElementById('simPlate').value.trim();
  const conf  = document.getElementById('simConf').value.trim();
  const payload = { plate: plate };
  if (conf) payload.confidence = parseFloat(conf);
  fetch('/simulate_detection',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
    .then(r=>r.json().then(j=>({ok:r.ok,status:r.status,body:j})))
    .then(res=>{
      if(res.ok){ flash('Szimul√°ci√≥: '+(res.body.result||'OK')); refreshEvents(); refreshStatus(); }
      else { flash(res.body.message || 'Hiba'); }
    });
  return false;
}
function flash(msg){ const el=document.getElementById('flash'); el.textContent=msg; setTimeout(()=>{el.textContent='';},4000); }

setInterval(refreshSnapshot, SNAPSHOT_MS);
setInterval(refreshEvents, EVENTS_MS);
setInterval(refreshStatus, STATUS_MS);
refreshSnapshot(); refreshEvents(); refreshStatus();
</script>
</body>
</html>
